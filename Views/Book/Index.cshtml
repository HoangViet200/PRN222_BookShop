@model IEnumerable<Book>
<div class="main-wrapper listing-page">
    <!-- Breadscrumb Section -->
    <div class="breadcrumb-bar">
        <div class="container">
            <div class="row align-items-center text-center">
                <div class="col-md-12 col-12">
                    <h2 class="breadcrumb-title">Car Listings</h2>
                </div>
            </div>
        </div>
    </div>
    <!-- /Breadscrumb Section -->
    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-warning w-100 text-center">
            Không tìm thấy sách nào phù hợp với yêu cầu tìm kiếm.
        </div>
    }
    else
    {
        <!-- Search -->
        <div class="section-search">
            <div class="container">
                <div class="search-box-banner">
                    <form asp-controller="Book" asp-action="Index" method="get">
                        <div class="row align-items-center g-2">
                            <div class="col-lg-10 col-md-9 col-sm-12">
                                <div class="input-block">
                                    <div class="group-img position-relative">
                                        <input type="text" name="keyword" value="@ViewBag.keyword" class="form-control" placeholder="Nhập tên sách hoặc từ khóa">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-3 col-sm-12">
                                <div class="input-block mt-4 mt-md-0">
                                    <button class="btn btn-primary w-100" type="submit">
                                        <i class="fa fa-search me-1" aria-hidden="true"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="categoryId" value="@ViewBag.SelectedCategoryId" />
                        <input type="hidden" name="subcategoryId" value="@ViewBag.SelectedSubCategoryId" />
                        <input type="hidden" name="authorId" value="@ViewBag.SelectedAuthorId" />
                        <input type="hidden" name="publisherId" value="@ViewBag.SelectedPublisherId" />
                        <input type="hidden" name="supplierId" value="@ViewBag.SelectedSupplierId" />
                    </form>
                </div>
            </div>
        </div>
        <!-- /Search -->
    
    <!-- Sort By -->
    <div class="sort-section">
        <div class="container">
            <div class="sortby-sec">
                <div class="sorting-div">
                    <div class="row d-flex align-items-center">
                        <div class="col-xl-4 col-lg-3 col-sm-12 col-12">
                        </div>
                        <div class="col-xl-8 col-lg-9 col-sm-12 col-12">
                            <div class="product-filter-group">
                                <div class="sortbyset">
                                    <form method="get" asp-controller="Book" asp-action="Index">
                                        <!-- Hidden fields để giữ các filter -->
                                        <input type="hidden" name="categoryId" value="@ViewBag.SelectedCategoryId" />
                                        <input type="hidden" name="subcategoryId" value="@ViewBag.SelectedSubCategoryId" />
                                        <input type="hidden" name="keyword" value="@ViewBag.Keyword" />
                                        <input type="hidden" name="authorId" value="@ViewBag.SelectedAuthorId" />
                                        <input type="hidden" name="supplierId" value="@ViewBag.SelectedSupplierId" />
                                        <input type="hidden" name="publisherId" value="@ViewBag.SelectedPublisherId" />

                                        <ul>
                                            <li>
                                                <span class="sortbytitle">Show : </span>
                                                <div class="sorting-select select-one">
                                                    <select class="form-control select" name="pageSize" onchange="this.form.submit()">
                                                        @foreach (var size in new int[] { 5, 10, 15 })
                                                        {
                                                            if (ViewBag.PageSize == size)
                                                            {
                                                                <option value="@size" selected="selected">@size</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@size">@size</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                            </li>
                                            <li>
                                                <span class="sortbytitle">Sort By </span>
                                                <div class="sorting-select select-two">
                                                    <select class="form-control select" name="sortOrder" onchange="this.form.submit()">
                                                        @{
                                                            var sortOptions = new[] { "all", "asc", "desc" };
                                                            var sortLabels = new[] { "All", "Low to High", "High to Low" };

                                                            for (int i = 0; i < sortOptions.Length; i++)
                                                            {
                                                                if (ViewBag.SortOrder == sortOptions[i])
                                                                {
                                                                    <option value="@sortOptions[i]" selected="selected">@sortLabels[i]</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@sortOptions[i]">@sortLabels[i]</option>
                                                                }
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                            </li>
                                        </ul>
                                        <input type="hidden" name="page" value="@ViewBag.Page" />
                                    </form>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Sort By -->
    
    <!-- Car Grid View -->
    <section class="section car-listing pt-0">
        <div class="container">
            <div class="row">
                <div class="col-xl-3 col-lg-4 col-sm-12 col-12 theiaStickySidebar">
                    <form asp-controller="Book" asp-action="Index" method="get" autocomplete="off" class="sidebar-form">
                        <div class="sidebar-heading">
                            <h3>What Are You Looking For:</h3>
                        </div>
                        <div class="accord-list">
                            <div class="accordion" id="accordionMain1">
                                <div class="card-header-new" id="headingOne">
                                    <h6 class="filter-title">
                                        <a href="javascript:void(0);" class="w-100" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            Nhóm sản phẩm
                                            <span class="float-end"><i class="fa-solid fa-chevron-down"></i></span>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample1">
                                    <div class="card-body-chat">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div id="checkBoxes1">
                                                    @await Component.InvokeAsync("Category")
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion" id="accordionMain2">
                                <div class="card-header-new" id="headingTwo">
                                    <h6 class="filter-title">
                                        <a href="javascript:void(0);" class="w-100 collapsed" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                                            Tác giả
                                        </a>
                                    </h6>
                                </div>
                                <div aria-labelledby="headingTwo" data-bs-parent="#accordionExample2">
                                    <div class="card-body-chat">
                                        <div id="checkBoxes2">
                                            @await Component.InvokeAsync("Author")
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion" id="accordionMain3">
                                <div class="card-header-new" id="headingYear">
                                    <h6 class="filter-title">
                                        <a href="javascript:void(0);" class="w-100 collapsed" data-bs-toggle="collapse" data-bs-target="#collapseYear" aria-expanded="true" aria-controls="collapseYear">
                                            Nhà xuất bản
                                        </a>
                                    </h6>
                                </div>
                                <div aria-labelledby="headingYear" data-bs-parent="#accordionExample2">
                                    <div class="card-body-chat">
                                        <div id="checkBoxes02">
                                            @await Component.InvokeAsync("Publisher")
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion" id="accordionMain4">
                                <div class="card-header-new" id="headingYear">
                                    <h6 class="filter-title">
                                        <a href="javascript:void(0);" class="w-100 collapsed" data-bs-toggle="collapse" data-bs-target="#collapsethree" aria-expanded="true" aria-controls="collapseYear">
                                            Nhà phát hành
                                        </a>
                                    </h6>
                                </div>
                                <div aria-labelledby="headingYear" data-bs-parent="#accordionExample2">
                                    <div class="card-body-chat">
                                        <div id="checkBoxes02">
                                            @await Component.InvokeAsync("Supplier")
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="d-inline-flex align-items-center justify-content-center btn w-100 btn-primary filter-btn">
                            <span><i class="feather-filter me-2"></i></span>Filter results
                        </button>
                        <a href="@Url.Action("Index", "Book")" class="reset-filter">Reset Filter</a>
                        <input type="hidden" name="keyword" value="@ViewBag.keyword" />
                    </form>
                </div>

                <div class="col-lg-9">
                    <div class="row">
                        <p>Book count: @Model?.Count()</p>
                        @foreach (var b in Model)
                        {
                            <!-- col -->
                            <div class="col-xxl-4 col-lg-6 col-md-6 col-12">
                                <div class="listing-item">
                                    <div class="listing-img">
                                        <a asp-controller="Book" asp-action="Detail" asp-route-bookId="@b.BookID">
                                            <img src="@b.ImageUrl" class="img-fluid">
                                        </a>
                                    </div>
                                    <h6 class="listing-title">
                                        <a asp-controller="Book" asp-action="Detail" asp-route-bookId="@b.BookID">@b.Name</a>
                                    </h6>
                                    <div class="listing-content">
                                        <div class="listing-location-details">
                                            <div class="listing-price">
                                                <h6>@string.Format("{0:#,##0} đ", b.UnitPrice)</h6>
                                            </div>
                                        </div>
                                        <div class="listing-button">
                                            <form asp-controller="Cart" asp-action="AddToCart" method="post">
                                                <input type="hidden" name="bookId" value="@b.BookID" />
                                                <input type="hidden" name="quantity" value="1" />
                                                <div class="listing-button">
                                                    <button type="button" class="btn btn-order btn-add-cart" data-id="@b.BookID">
                                                        <span><i class="feather-shopping-cart me-2"></i></span>Thêm vào giỏ hàng
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /col -->
                        }
                    </div>
                    <!--Pagination-->
                    <div class="blog-pagination">
                        <nav>
                            <ul class="pagination page-item justify-content-center">
                                <!-- Prev -->
                                @if (ViewBag.Page > 1)
                                {
                                    <li class="previtem">
                                        <form method="get" asp-controller="Book" asp-action="Index" style="display:inline;">
                                            <input type="hidden" name="page" value="@(ViewBag.Page - 1)" />
                                            <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                                            <input type="hidden" name="sortOrder" value="@ViewBag.SortOrder" />
                                            <input type="hidden" name="keyword" value="@ViewBag.Keyword" />
                                            <input type="hidden" name="categoryId" value="@ViewBag.SelectedCategoryId" />
                                            <input type="hidden" name="subcategoryId" value="@ViewBag.SelectedSubCategoryId" />
                                            <input type="hidden" name="publisherId" value="@ViewBag.SelectedPublisherId" />
                                            <input type="hidden" name="authorId" value="@ViewBag.SelectedAuthorId" />
                                            <input type="hidden" name="supplierId" value="@ViewBag.SelectedSupplierId" />
                                            <button class="page-link" type="submit">
                                                <i class="fas fa-regular fa-arrow-left me-2"></i> Prev
                                            </button>
                                        </form>
                                    </li>
                                }

                                <!-- Số trang -->
                                <li class="justify-content-center pagination-center">
                                    <div class="page-group">
                                        <ul>
                                            @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                            {
                                                <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                                                    <form method="get" asp-controller="Book" asp-action="Index" style="display:inline;">
                                                        <input type="hidden" name="page" value="@i" />
                                                        <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                                                        <input type="hidden" name="sortOrder" value="@ViewBag.SortOrder" />
                                                        <input type="hidden" name="keyword" value="@ViewBag.Keyword" />
                                                        <input type="hidden" name="categoryId" value="@ViewBag.SelectedCategoryId" />
                                                        <input type="hidden" name="subcategoryId" value="@ViewBag.SelectedSubCategoryId" />
                                                        <input type="hidden" name="publisherId" value="@ViewBag.SelectedPublisherId" />
                                                        <input type="hidden" name="authorId" value="@ViewBag.SelectedAuthorId" />
                                                        <input type="hidden" name="supplierId" value="@ViewBag.SelectedSupplierId" />
                                                        <button class="page-link" type="submit">@i</button>
                                                    </form>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </li>

                                <!-- Next -->
                                @if (ViewBag.Page < ViewBag.TotalPages)
                                {
                                    <li class="nextlink">
                                        <form method="get" asp-controller="Book" asp-action="Index" style="display:inline;">
                                            <input type="hidden" name="page" value="@(ViewBag.Page + 1)" />
                                            <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                                            <input type="hidden" name="sortOrder" value="@ViewBag.SortOrder" />
                                            <input type="hidden" name="keyword" value="@ViewBag.Keyword" />
                                            <input type="hidden" name="categoryId" value="@ViewBag.SelectedCategoryId" />
                                            <input type="hidden" name="subcategoryId" value="@ViewBag.SelectedSubCategoryId" />
                                            <input type="hidden" name="publisherId" value="@ViewBag.SelectedPublisherId" />
                                            <input type="hidden" name="authorId" value="@ViewBag.SelectedAuthorId" />
                                            <input type="hidden" name="supplierId" value="@ViewBag.SelectedSupplierId" />
                                            <button class="page-link" type="submit">
                                                Next <i class="fas fa-regular fa-arrow-right ms-2"></i>
                                            </button>
                                        </form>
                                    </li>
                                }
                            </ul>
                        </nav>
                    </div>
                    <!--/Pagination-->


                </div>
            </div>
        </div>
    </section>
    <!-- /Car Grid View -->
    }
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).on('click', '.btn-add-cart', function () {
        var bookId = $(this).data('id');
        $.post('/Cart/AddToCartAjax', { bookId: bookId, quantity: 1 }, function (response) {
            if (response.success) {
                alert("Đã thêm vào giỏ hàng! Tổng số sản phẩm: " + response.totalItems);
                // Hoặc cập nhật icon giỏ hàng:
                $('#cart-count').text(response.totalItems);
            }
        });
    });
</script>
